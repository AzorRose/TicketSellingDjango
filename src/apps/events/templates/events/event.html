{% load static %}

{% block content %}
    <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <meta name="author" content="Марат Маур">
          <meta name="description" content="Тестовая страница">
          <meta name="keywords" content="тест,проверка,html">
          <title>{{ event.name }}</title>
          <link rel="icon" type="image/x-icon" href="{% static 'main/icon/favicon.ico' %}">
          <link rel="stylesheet" href="{% static 'main/lib/bootstrap-5.3.1-dist/css/bootstrap.min.css' %}">
          <link rel="stylesheet" href="{% static 'main/css/main.css' %}">
          <link rel="stylesheet" href="{% static 'main/schemas/Frame.svg' %}">
          <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
          <script src="https://api-maps.yandex.ru/2.1/?apikey=ваш API-ключ&&lang=ru_RU&load=Geolink""></script>
          <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0"/>
        </head>
        <body>
            {% include "accounts/header_fragment.html" %}
            <section id="event-section" data-filter={{ filter }} data-slug="{{ slug }}">
                <div class="container" id="event-container">
                    <img src="{{ event.image.url|slice:'12:' }}" alt="{{ event.name }}" height="300" width="300">
                    <div class="event-info">
                        <h3>{{ event.name }}</h3>
                        <br>
                        Дата проведения:
                        {{ event.end_date }}
                        <br>
                        Место проведения:
                        {{ event.place }}, {{ area.name }}
                        <br>
                        Возрастное ограничение:
                        {{ event.ages }}
                        <br>
                        Стоимость:
                        {% if num_tickets > 1 %}
                            от {{ min_price }} руб.
                        {% else %}
                            {{ min_price }} руб.
                        {% endif %}
                        <br>
                        Адрес:
                        {{ area.building.address }}
                        <br>
                        {% if event.has_available_seat or event.has_available_balcony or event.has_available_dance_floor %}
                            <a onclick="openModal()" class="btn btn-sm" id="buy-event">Купить билет</a>
                        {% else %}
                            <h5 class="no-places">Нет доступных мест</h5>
                        {% endif %}
                    </div>
                </div>
                {% if user.is_authenticated %}
                    <div id="myModal" class="modal authorized">
                        <h3>{{ event.name }}</h3>
                        <time>{{ event.end_date }}</time>
                        <div class="address-container">
                            <div>{{ event.place }}</div>
                            <div>{{ area.building.address }}</div>
                        </div>
                        <div>
                            <div class="place-container">
                                <div class="btn-place-group ">
                                    <button class="choice active" id="button1">Схема зала</button>
                                    <button class="choice" id="button2">Доступные билеты</button>
                                </div>
                                <div id="schema" class="input-container">
                                    <div class="info-form">
                                        <div class="zoom-btns">
                                            <button class="zoom-in" id="zoom-in">+</button>
                                            <button class="zoom-out" id="zoom-out">-</button>
                                        </div>
                                        {{ svg|safe }}
                                    </div>
                                    <div id="footer-place-container" class="footer-place-container">
                                        <p id="tooltip"></p>
                                        <button class="add-to-cart-btn" id="add-to-cart-btn">В корзину</button>
                                    </div>
                                </div>
                                <div id="available-seats" class="input-container">
                                    {% for t in ticket %}
                                        {% for spot_value, spot_display in t.spots %}
                                            {% if t.spot == spot_value %}
                                                {% if spot_value == "seat" %}
                                                    <div id="seat-spot" class="spot">{{ spot_display }}</div>
                                                {% else %}
                                                    <div onclick="openDancefloorPopup()" class="spot">{{ spot_display }}</div>  
                                                    <div id="dancefloor-popup" class="dancefloor-popup">
                                                        <div><h5>Купить билет</h5></div>
                                                        <div>
                                                            <p>Танцпол</p>
                                                            {% for t in ticket %}
                                                                {% if t.spot == "dance_floor" %}
                                                                    <p>Стоимость: {{ t.price }} руб.</p>
                                                                    <button class="add-to-cart-btn" data-ticket-id="{{ t.id }}">В корзину</button>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>     
                                                    </div>
                                                    <div id="dancefloor-overlay" class="overlay" onclick="closeDancefloorPopup()"></div>                                        
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                    
                                </div>
                            
                            </div>
                        </div>
                        
                        <a onclick="closeModal()" class="modal-button">
                            <img src="{% static 'main/images/xmark.png' %}" width="15" height="19">
                        </a>
                    </div>
                    
                    <div id="overlay" class="overlay" onclick="closeModal()"></div>
                    
                {% else %}
                    <div id="myModal" class="modal none-authorized">
                        <p>Для покупки нужно авторизоваться</p>
                        <a href="{% url 'signin' %}" class="auth-btn">Войти</a>
                        <a onclick="closeModal()" class="modal-button">
                            <img src="{% static 'main/images/xmark.png' %}" width="15" height="19">
                        </a>
                    </div>
                    <div id="overlay" class="overlay" onclick="closeModal()"></div>
                {% endif %}
                <div class="container" id="description">
                    <p>{{ event.description }}</p>
                </div>
                <div class="container" id="map-container">
                    {{ area.building.map_adress|safe }}

                </div>
            </section>
            {% include "accounts/footer_fragment.html" %}
        <script>
            $(document).ready(function() {
                $('.add-to-cart-btn').on('click', function() {
                    var ticketId = $(this).data('ticket-id');
            
                    $.ajax({
                        type: 'POST',
                        url: '/add_to_cart/' + ticketId + '/',
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function(response) {
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });
                });
            });      
        </script>            
        <script src="{% static 'main/js/buyEventPopup.js' %}"></script>
        <script src="{% static 'main/js/place.js' %}"></script>
        <script src="{% static 'main/js/search.js' %}"></script>
        <script src="{% static 'main/js/svg.js' %}"></script>
        </body>
      </html>

{% endblock %}
